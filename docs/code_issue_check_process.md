# DynamicAPI 代码问题检查标准与流程

本流程用于在提交或合并前系统性发现问题，覆盖安全性、正确性、健壮性、可维护性和测试保障。按顺序执行，确保可重复、可追踪。

## 适用范围
- DynamicAPI 及 DynamicAPICombine 源码、配置模板与测试代码。
- 新增/修改的请求处理器、映射器、配置解析逻辑、目标构建逻辑、并发与错误处理逻辑。

## 输出要求
- 发现的问题需按严重度标注：
  - `blocker`：会导致编译失败、崩溃、数据破坏、安全漏洞或明显逻辑错误。
  - `major`：功能受影响或行为不符合预期，但有替代路径或降级方案。
  - `minor`：可用性、性能、可维护性或测试覆盖不足的问题。
- 记录：文件、行号/位置、现象、期望、建议修复；无法确定时写出假设与待确认问题。

## 基础认知（理解后再审查）
- 配置驱动：`APIConfig` -> `ResolvedOperation` -> `DynamicTarget` -> Moya 请求。
- 解析路径/参数：`ParamResolver` 支持 `$placeholder`、`$$` 转义、递归解析、路径编码。
- 扩展点：`RequestProcessor` 可改参数/头；`ResponseMapper` 可定制解包；`DynamicAPIClient` 支持 async/await 与 Combine。
- 安全基线：绝对 URL 禁止、路径遍历编码、敏感 Header 黑名单过滤。

## 检查流程
1) **范围与基线**
   - 明确变更范围：功能点、文件列表、关联测试。
   - 了解预期行为（需求/issue/PR 描述）与现有测试（Tests/ 下对应用例）。
  - 若涉及远程下发配置，确认：客户端已与组件约定可信配置域名、强制 HTTPS；源码未被篡改前提下，域名/协议不可被远程配置修改。

2) **静态逻辑检查（逐层）**
   - **配置解析**：
     - 绝对/双斜杠路径是否拒绝；`encoding` 与 HTTP 方法匹配（GET 不应有 body/form/json）；`use_presets` 指向存在的预设；baseURL 可解析。
     - Header 合并顺序与黑名单过滤是否正确（避免 Host/Content-Length 注入）。
   - **参数与路径解析**：
     - `$` 占位符缺失是否抛 `parameterError`，类型是否保持（不应隐式转字符串）。
     - 路径参数是否进行 URL 编码，避免 `../`、`://` 穿透；多余 runtime 参数是否被忽略。
   - **目标构建 (`DynamicTarget`)**：
     - task 构建是否符合配置：encoding 选项、query+body 组合、download 目标路径、安全的默认处理。
     - headers/params/body 是否使用已解析值，避免重复解析或遗漏。
   - **客户端流程 (`DynamicAPIClient`/Combine)**：
     - 处理器运行次数是否合理（避免重复签名/注入）；缺失处理器/映射器时的行为是否与设计一致（报错或回退）。
     - 错误映射是否一致：状态码过滤、解码错误归类、unknown 兜底。
     - 并发安全：共享注册表（mappers/processors）访问是否加锁；Sendable 要求是否满足。
   - **安全与健壮性**：
     - 阻断路径遍历、域名注入、Header 注入；对下载/上传路径的覆盖策略是否安全。
     - 对不可预期数据的防御：nil/空集合处理、默认分支、日志级别。

3) **测试对照**
   - 现有测试矩阵：配置验证、安全、解析、目标构建、下载、并发、Bilibili 签名等。
   - 检查变更是否需要新增/更新测试：
     - 新的编码模式、task 类型、处理器/映射器分支。
     - 错误路径（缺参、非法路径、mapper 未注册、状态码错误）。
   - 运行目标：`swift test`（如有网络依赖，确认跳过条件如 `ENABLE_DOWNLOAD_TEST`）。

4) **行为一致性**
   - async/await 与 Combine 版本是否在处理器执行、状态码过滤、错误映射上保持一致。
   - 默认行为（找不到 mapper/processor 时）是否符合文档/约定；如有偏差需记录并决定改动或更新文档。

5) **性能与可维护性（次要但需记录）**
   - 重复解析、重复处理器调用、无谓的数据拷贝；可否复用已解析结果。
   - 日志是否过度/不足；API/协议是否需要标注可扩展性（如处理器需要 body/path）。

6) **结论与输出**
   - 按严重度列出问题，附文件位置与建议；未决问题列在 “Open Questions”。
   - 如无发现，记录“未发现问题”，同时标注潜在风险或测试覆盖空白。

## 复核清单（勾选）
- [ ] 配置与安全：编码合法、预设存在、拒绝绝对路径、黑名单头过滤。
- [ ] 参数/路径解析：缺参抛错、类型保持、路径编码、忽略多余参数。
- [ ] 目标构建：encoding 与方法匹配，query/body/下载任务构造正确。
- [ ] 客户端/Combine：处理器调用次数正确，状态码过滤一致，错误映射一致，缺失 mapper/processor 行为明确。
- [ ] 并发与共享状态：注册表读写安全，Sendable 满足。
- [ ] 测试：新增/变更逻辑有对应正反向用例；必要时运行 `swift test` 并记录。
- [ ] 输出：问题按严重度记录；无发现则说明风险与覆盖空白。
